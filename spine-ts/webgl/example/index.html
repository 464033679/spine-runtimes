<html>
<script src="../../build/spine-webgl.js"></script>
<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
<body>
<canvas id="canvas" style="width: 640; height: 480"></canvas>
<div id="info"></div>
</body>
<script>

var canvas = null;
var shader = null;
var batcher = null;
var gl = null;
var mvp = new spine.webgl.Matrix4();
var assetManager = new spine.webgl.AssetManager();
var texture = null;
var atlas = null;
var polygons = [];
var info = $("#info");

function init() {    
    // setup canvas and WebGL context
    canvas = document.getElementById("canvas");
    canvas.width = 640;
    canvas.height = 480;
    gl = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");        
    spine.webgl.init(gl);
    
    // Create a simple shader, mesh and MVP matrix
    shader = spine.webgl.Shader.newColoredTextured();
    batcher = new spine.webgl.PolygonBatcher();    
    mvp.ortho2d(0, 0, 639, 479);

    // Tell AssetManager to load a few resources, then
    // hand control to load() function
    assetManager.loadText("assets/spineboy.json");
    assetManager.loadText("assets/spineboy.atlas");
    assetManager.loadTexture("assets/spineboy.png");
    requestAnimationFrame(load);

    // Create a bunch of x/y/width/height polies
    for (var i = 0; i < 10; i++) {
        polygons.push({ x: Math.random() * 600, y: Math.random() * 400, w: Math.random() * 50, h: Math.random() * 50});
    }
}

function load() {
    if (assetManager.isLoadingComplete()) {
        texture = assetManager.get("assets/spineboy.png");

        atlas = new spine.webgl.TextureAtlas(assetManager.get("assets/spineboy.atlas"), function(path) {
            return assetManager.get("assets/" + path);
        });

        requestAnimationFrame(render);
    }
    else requestAnimationFrame(load);
}

function render() {
    gl.clearColor(0, 1, 0, 1);
    gl.clear(gl.COLOR_BUFFER_BIT);

    shader.bind();
    shader.setUniformi(spine.webgl.Shader.SAMPLER, 0);
    shader.setUniform4x4f(spine.webgl.Shader.MVP_MATRIX, mvp.values);        

    batcher.begin(shader);
    for (var i = 0; i < polygons.length; i++) {
        var p = polygons[i];        
        batcher.draw(texture, [
            p.x, p.y, 1, 1, 1, 1, 0, 0,
            p.x + p.w, p.y, 1, 1, 1, 1, 1, 0,
            p.x + p.w, p.y + p.h, 1, 1, 1, 1, 1, 1,
            p.x, p.y + p.h, 1, 1, 1, 1, 0, 1
        ], [0, 1, 2, 2, 3, 0]);
    }
    batcher.end();
    
    shader.unbind();    

    info.html("drawcalls: " + batcher.drawCalls());

    requestAnimationFrame(render);
}

(function() {
    init();
})();

</script>
</html>