<html>
<script src="../../build/spine-webgl.js"></script>
<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
<body>
<canvas id="canvas" style="width: 640; height: 480"></canvas>
<div id="info"></div>
</body>
<script>

var canvas = null;
var shader = null;
var batcher = null;
var gl = null;
var mvp = new spine.webgl.Matrix4();
var assetManager = new spine.webgl.AssetManager();
var skeletonRenderer = null;
var skeleton = null;
var animationState = null;
var info = $("#info");

function init() {    
    // setup canvas and WebGL context
    canvas = document.getElementById("canvas");
    canvas.width = 640;
    canvas.height = 480;
    gl = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");        
    spine.webgl.init(gl);
    
    // Create a simple shader, mesh, model-view-projection matrix
    // and SkeletonRenderer
    shader = spine.webgl.Shader.newColoredTextured();
    batcher = new spine.webgl.PolygonBatcher();
    mvp.ortho2d(0, 0, 639, 479);
    skeletonRenderer = new spine.webgl.SkeletonRenderer();

    // Tell AssetManager to load a few resources, then
    // hand control to load() function
    assetManager.loadText("assets/spineboy.json");
    assetManager.loadText("assets/spineboy.atlas");
    assetManager.loadTexture("assets/spineboy.png");
    assetManager.loadText("assets/raptor.json");
    assetManager.loadText("assets/raptor.atlas");
    assetManager.loadTexture("assets/raptor.png");
    assetManager.loadText("assets/tank.json");
    assetManager.loadText("assets/tank.atlas");
    assetManager.loadTexture("assets/tank.png");
    assetManager.loadText("assets/simple.json");
    assetManager.loadText("assets/simple.atlas");
    assetManager.loadTexture("assets/simple.png");
    requestAnimationFrame(load);
}

function load() {
    if (assetManager.isLoadingComplete()) {  
        var skeletonData = loadSkeletonJson("raptor");
        skeleton = new spine.Skeleton(skeletonData);
        skeleton.x = 320;
        skeleton.y = 20;        
        animationState = new spine.AnimationState(new spine.AnimationStateData(skeletonData));
        animationState.setAnimation(0, "walk", true);       

        requestAnimationFrame(render);
    } else {
        requestAnimationFrame(load);
    } 
}

function loadSkeletonJson(name) {    
    atlas = new spine.webgl.TextureAtlas(assetManager.get("assets/" + name + ".atlas"), function(path) {
        return assetManager.get("assets/" + path);
    });
    atlasLoader = new spine.webgl.TextureAtlasAttachmentLoader(atlas);
    var skeletonJson = new spine.SkeletonJson(atlasLoader);
    skeletonJson.scale = 0.5;   
    return skeletonJson.readSkeletonData(assetManager.get("assets/" + name + ".json"));
}

function render() {
    gl.clearColor(0.3, 0.3, 0.3, 1);
    gl.clear(gl.COLOR_BUFFER_BIT);

     // apply the animation state based on the delta time
    animationState.update(0.016);
    animationState.apply(skeleton);
    skeleton.updateWorldTransform();

    // bind the shader and set the texture
    // and model-view-projection matrix
    shader.bind();
    shader.setUniformi(spine.webgl.Shader.SAMPLER, 0);
    shader.setUniform4x4f(spine.webgl.Shader.MVP_MATRIX, mvp.values);        

    batcher.begin(shader);    
    skeletonRenderer.draw(batcher, skeleton);
    batcher.end();
    
    shader.unbind();    

    info.html("drawcalls: " + batcher.drawCalls());

    requestAnimationFrame(render);
}

(function() {
    init();
})();

</script>
</html>